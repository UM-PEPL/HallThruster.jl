<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Implement an anomalous transport model · HallThruster.jl</title><meta name="title" content="Implement an anomalous transport model · HallThruster.jl"/><meta property="og:title" content="Implement an anomalous transport model · HallThruster.jl"/><meta property="twitter:title" content="Implement an anomalous transport model · HallThruster.jl"/><meta name="description" content="Documentation for HallThruster.jl."/><meta property="og:description" content="Documentation for HallThruster.jl."/><meta property="twitter:description" content="Documentation for HallThruster.jl."/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><link href="../../assets/citation.css" rel="stylesheet" type="text/css"/><link href="../../assets/favicon.ico" rel="icon" type="image/x-icon"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.svg" alt="HallThruster.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">HallThruster.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Overview</a></li><li><a class="tocitem" href="../../NEWS/">Release notes</a></li><li><input class="collapse-toggle" id="menuitem-3" type="checkbox"/><label class="tocitem" for="menuitem-3"><span class="docs-label">Tutorials</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../tutorials/simulation/">Run a simulation</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4" type="checkbox" checked/><label class="tocitem" for="menuitem-4"><span class="docs-label">How-to guides</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../json/">Use JSON input and output</a></li><li><a class="tocitem" href="../python/">Run a simulation from python</a></li><li><a class="tocitem" href="../new_propellant/">Add a new propellant</a></li><li class="is-active"><a class="tocitem" href>Implement an anomalous transport model</a><ul class="internal"><li><a class="tocitem" href="#Static-transport-model"><span>Static transport model</span></a></li><li><a class="tocitem" href="#Time-varying-transport-model"><span>Time-varying transport model</span></a></li><li><a class="tocitem" href="#Advanced-usage:-implementing-additional-PDEs-for-anomalous-transport"><span>Advanced usage: implementing additional PDEs for anomalous transport</span></a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-5" type="checkbox"/><label class="tocitem" for="menuitem-5"><span class="docs-label">Explanations</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../explanation/physics/">Physics model</a></li><li><a class="tocitem" href="../../explanation/numerics/">Numerics</a></li><li><a class="tocitem" href="../../explanation/grid_generation/">Grid generation</a></li><li><a class="tocitem" href="../../explanation/timestepping/">Timestepping</a></li><li><a class="tocitem" href="../../explanation/verification/">Validation and verification</a></li><li><a class="tocitem" href="../../explanation/initialization/">Initialization</a></li><li><a class="tocitem" href="../../explanation/plume/">Quasi-1D plume model</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-6" type="checkbox"/><label class="tocitem" for="menuitem-6"><span class="docs-label">Reference</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../reference/config/">Configuration</a></li><li><a class="tocitem" href="../../reference/simparams/">Simulation parameters</a></li><li><a class="tocitem" href="../../reference/solution/">Solution</a></li><li><a class="tocitem" href="../../reference/postprocessing/">Postprocessing</a></li><li><a class="tocitem" href="../../reference/thrusters/">Thrusters</a></li><li><a class="tocitem" href="../../reference/propellants/">Propellants</a></li><li><a class="tocitem" href="../../reference/anomalous_transport/">Anomalous transport models</a></li><li><a class="tocitem" href="../../reference/wall_loss_models/">Wall loss models</a></li><li><a class="tocitem" href="../../reference/electron_thermal_conductivity/">Thermal conductivity models</a></li><li><a class="tocitem" href="../../reference/collisions/">Collisions and reactions</a></li><li><a class="tocitem" href="../../reference/schemes/">Hyperbolic schemes</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">How-to guides</a></li><li class="is-active"><a href>Implement an anomalous transport model</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Implement an anomalous transport model</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/UM-PEPL/HallThruster.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/UM-PEPL/HallThruster.jl/blob/main/docs/src/howto/new_anom_model.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Adding-an-anomalous-transport-model"><a class="docs-heading-anchor" href="#Adding-an-anomalous-transport-model">Adding an anomalous transport model</a><a id="Adding-an-anomalous-transport-model-1"></a><a class="docs-heading-anchor-permalink" href="#Adding-an-anomalous-transport-model" title="Permalink"></a></h1><p>Users of HallThruster may define their own models by defining a custom subtype of <code>AnomalousTransportModel</code> and a few methods.</p><h2 id="Static-transport-model"><a class="docs-heading-anchor" href="#Static-transport-model">Static transport model</a><a id="Static-transport-model-1"></a><a class="docs-heading-anchor-permalink" href="#Static-transport-model" title="Permalink"></a></h2><p>Suppose we want to implement <span>$nu_{AN} = \beta \omega_{ce}$</span> (classic Bohm diffusion). This is a fixed anomalous transport model and does not change as the simulation progresses. We would first define our type:</p><pre><code class="language-julia hljs">using HallThruster

struct BohmDiffusion &lt;: AnomalousTransportModel
    β::Float64
end</code></pre><p>We then need to define the function which computes the anomalous transport in each cell. This is a mutating function which takes two arguments: the vector of anomalous collision frequency values to be updated, and the solver params.</p><pre><code class="language-julia hljs">function (model::BohmDiffusion)(νan, params, config)
    e = HallThruster.e
    me = HallThruster.me
    B = params.cache.B

    for i in eachindex(νan)
        ωce = e * B[i] / me
        νan[i] = model.β * ωce
    end

    return νan
end</code></pre><p>We can now set <code>anom_model = BohmDiffusion</code> in our <a href="../../reference/config/#HallThruster.Config"><code>Config</code></a> struct.</p><h2 id="Time-varying-transport-model"><a class="docs-heading-anchor" href="#Time-varying-transport-model">Time-varying transport model</a><a id="Time-varying-transport-model-1"></a><a class="docs-heading-anchor-permalink" href="#Time-varying-transport-model" title="Permalink"></a></h2><p>Bohm diffusion is a very simple transport model that does not change over time. More complex, physics-based models may depend self-consistently on local plasma properties and evaolve in time</p><p>Let&#39;s compute an anomalous transport that depends on energy density of electrostatic waves in the plasma. This model derives from Lafleur, Chabert, and Balruud [<a href="#Lafleur2016Model">1</a>] and has the following form:</p><p class="math-container">\[\begin{aligned}
\nu_{AN} = K \frac{\nabla \cdot \mathbf{u}_i W}{m_e n_e c_s v_{de}}
\end{aligned}\]</p><p>In this expression, <span>$K$</span> is a tunable coefficient, <span>$u_i$</span> is the ion velocity, <span>$W = n_e k_B T_e$</span> is the wave energy density, <span>$m_e$</span> is the electron mass, <span>$n_e$</span> is the electron number density, <span>$c_s$</span> is the ion sound speed, and <span>$v_{de}$</span> is the electron azimuthal drift speed. Let&#39;s say we want to save the wave energy density in addition to the anomalous collision frequency, for later analysis. We begin by defining the model:</p><pre><code class="language-julia hljs">struct LafleurModel &lt;: AnomalousTransportModel
    K::Float64
end</code></pre><p>Next, we add a method to the <a href="../../reference/anomalous_transport/#HallThruster.num_anom_variables"><code>num_anom_variables</code></a> function.  This function is part of the <a href="../../reference/anomalous_transport/#Anomalous-transport">Anomalous transport</a> interface and tells <code>HallThruster</code> how many extra arrays we need to allocate during simulation initializion. These arrays store one value per cell. Since we want to save the wave energy density, we need 1 anomalous transport variable.</p><pre><code class="language-julia hljs">num_anom_variables(::LafleurModel) = 1</code></pre><p>Now, we define the behavior of the model in a function, just as we did for <code>Bohm</code>. Since the model is based on assuming the wave energy convects with the ions, we will use upwind differencing for the gradient.</p><pre><code class="language-julia hljs">function (model::LafleurModel)(νan, params, config)
    (;grid, cache) = params
    z = grid.cell_centers
    mi = config.propellant.m
    K = model.K
    e = HallThruster.e
    me = HallThruster.me
    (;ne, Tev, ue, ui, νe, anom_variables) = cache

    ncells = length(νan)

    for i in 2:ncells-1

        W = e * ne[i] * Tev[i]
        Hall_param = e * B[i] / me / νe[i]
        vde = Hall_param * ue[i]
        cs = sqrt(e * Tev[i] / mi)

        # Upwind differencing of gradient term
        if ui &gt; 0
            dz = z[i] - z[i-1]
            W_left = e * ne[i-1] * Tev[i-1]
            grad_ui_W = (ui[1, i] * W[i] - ui[1, i-1] * W_left) / dz
        else
            dz = z[i+1] - z[i]
            W_right = e * ne[i+1] * Tev[i+1]
            grad_ui_W = (ui[1, i+1] * W_right - ui[i] * W[i]) / dz
        end

        # Save W to cache.anom_variables[1]
        anom_variables[1][i] = W

        # Return anomalous collision frequency
        νan[i] = abs(K * grad_ui_W / (me * cs * vde * ne))
    end

    # Neumann boundary condition for all variables
    anom_variables[1][1] = anom_variables[1][2]
    anom_variables[1][end] = anom_variables[1][end-1]
    νan[1] = νan[2]
    νan[end] = νan[end-1]

    return νan
end</code></pre><p>Once the solution has been generated by calling <a href="../../reference/simparams/#HallThruster.run_simulation-Tuple{HallThruster.Config, HallThruster.SimParams}"><code>run_simulation</code></a> with appropriate arguments, we can retrieve the wave energy density at frame <code>i</code> as</p><pre><code class="language-julia hljs">W = solution.frames[i].anom_variables[1]</code></pre><p>Models like this can become unstable quickly, so <code>HallThruster</code> also supports the ability to smooth the anomalous transport. This can be accomplished using the <code>anom_smoothing_iters</code> key of the <a href="../../reference/config/#HallThruster.Config"><code>Config</code></a>, which determines the number of times a smoothing filter will be applied to the results of the transport calculation.</p><h2 id="Advanced-usage:-implementing-additional-PDEs-for-anomalous-transport"><a class="docs-heading-anchor" href="#Advanced-usage:-implementing-additional-PDEs-for-anomalous-transport">Advanced usage: implementing additional PDEs for anomalous transport</a><a id="Advanced-usage:-implementing-additional-PDEs-for-anomalous-transport-1"></a><a class="docs-heading-anchor-permalink" href="#Advanced-usage:-implementing-additional-PDEs-for-anomalous-transport" title="Permalink"></a></h2><p>The most complex anomalous transport might require the solution of one or more additional PDEs. This can be accomplished using the same machinery we used above. We demonstrate this by solving the scalar advection equation using first-order upwind differencing in space and forward Euler integration in time, with periodic boundary conditions. The scalar advection equation is given by:</p><p class="math-container">\[\begin{aligned}
\frac{\partial u}{\partial t} + a \frac{\partial u}{\partial x} = 0
\end{aligned}\]</p><p>To begin, we define the model struct and the number of variables we need.</p><pre><code class="language-julia hljs">using HallThruster, Plots

struct ScalarAdvection{F} &lt;: HallThruster.AnomalousTransportModel
    advection_velocity::Float64  # Advection advection_velocity
    initializer::F  # Initialization function
end

# Save two auxilliary variables
#   1) Advected quantity u
#   2) gradient of advected quantity (du/dz)
HallThruster.num_anom_variables(::ScalarAdvection) = 2</code></pre><p>Next, we define the model function:</p><pre><code class="language-julia hljs">function (model::ScalarAdvection)(νan, params, config)
    ncells = length(νan)

    # Extract variables from params
    cache = params.cache
    z = params.z_cell
    u = cache.anom_variables[1]
    du_dz = cache.anom_variables[2]
    a = model.advection_velocity
    dt = params.dt

    if params.iteration[] &lt; 1
        # Initialize
        model.initializer(u, z)
    else
        for i in eachindex(νan)
            # Setup for periodic boundary conditions
            if i == 1
                i_minus_1 = ncells
                dz_minus = z[2] - z[1]
            else
                i_minus_1 = i - 1
                dz_minus = z[i] - z[i-1]
            end

            if i == ncells
                i_plus_1 = 1
                dz_plus = z[2] - z[1]
            else
                i_plus_1 = i + 1
                dz_plus = z[i+1] - z[i]
            end

            # Update gradient using upwind differencing
            if a &gt; 0
                du_dz[i] = (u[i] - u[i_minus_1]) / dz_minus
            else
                du_dz[i] = (u[i_plus_1] - u[i]) / dz_plus
            end
        end

        # Update advected quantity
        for i in eachindex(νan)
            u[i] -= a * du_dz[i] * dt
        end
    end

    # Return a two-zone bohm anomalous transport result,
    # since we don&#39;t really care about the anomalous transport in this case.
    # In a more general case, you would set `νan` based on the results of the PDE
    return HallThruster.TwoZoneBohm(1/160, 1/16)(νan, params)
end</code></pre><p>And that&#39;s it! Now all there is to do is define our simulation parameters and run!</p><pre><code class="language-julia hljs"># Set up config
advection_velocity = 1e5
L = 0.08

config = HallThruster.Config(
    domain = (0.0, L),
    anom_model = ScalarAdvection(advection_velocity, initializer),
    thruster = HallThruster.SPT_100,
    discharge_voltage = 300.0,
    anode_mass_flow_rate = 5e-6
)

# Define dt such that CFL condition is obeyed for scalar advection
# Note -- this CFL number is different from the CFL number used by `HallThruster`
dx = L / ncells
CFL = 0.9
dt = min(1e-8, dx * CFL / advection_velocity)
nsteps = 1000
duration = nsteps * dt
simparams = SimParams(
    adaptive = false,
    nsave = nsteps,
    grid = HallThruster.EvenGrid(200)
    dt = dt, duration = duration,
)
ncells = 200

# Run simulation
solution = HallThruster.run_simulation(config, simparams)

# Extract variables from solution
z = solution[:z]
u = [frame.anom_variables[1] for frame in solution.frames]</code></pre><p>We can now use a plotting package of our choice to visualize the results to make sure everything worked well. In this case we will use <a href="https://docs.juliaplots.org/stable/">Plots</a>.</p><pre><code class="language-julia hljs">using Plots

# Time needed to transit the domain
t_transit = L / advection_velocity

# Number of periods
num_periods = floor(Int, nsteps * dt / t_transit)

# Plot results
p = plot(; framestyle = :box, xlabel = &quot;x&quot;, ylabel = &quot;u&quot;, title = &quot;First order upwind for scalar advection&quot;)
for i in 0:num_periods
    index = round(Int, i * t_transit / dt) + 1
    plot!(
        p, z, u[index], label = &quot;After $i periods&quot;,
        linecolor = cgrad(:turbo, num_periods + 1, categorical = true)[i+1]
    )
end
display(p)</code></pre><p><img src="https://github.com/UM-PEPL/HallThruster.jl/blob/main/docs/src/assets/scalar_advection.png?raw=true" alt/></p><p>This looks correct! In this case, we haven&#39;t coupled our PDE solution to the anomalous transport, but one could easily do this. In the same way, systems of two, three, or more coupled PDEs can be solved and related to the anomalous collision frequency.</p><div class="citation canonical"><dl><dt>[1]</dt><dd><div id="Lafleur2016Model">T. Lafleur, S. D. Baalrud and P. Chabert. <a href="http://dx.doi.org/10.1063/1.4948496]"><em>Theory for the anomalous electron transport in Hall effect thrusters. II. Kinetic model</em></a>. <a href="https://doi.org/10.1063/1.4948496">Physics of Plasmas <strong>23</strong>, 11101</a> (2016).</div></dd></dl></div></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../new_propellant/">« Add a new propellant</a><a class="docs-footer-nextpage" href="../../explanation/physics/">Physics model »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.8.0 on <span class="colophon-date" title="Wednesday 22 January 2025 21:31">Wednesday 22 January 2025</span>. Using Julia version 1.11.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
