<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Couple HallThruster.jl to C or Fortran · HallThruster.jl</title><meta name="title" content="Couple HallThruster.jl to C or Fortran · HallThruster.jl"/><meta property="og:title" content="Couple HallThruster.jl to C or Fortran · HallThruster.jl"/><meta property="twitter:title" content="Couple HallThruster.jl to C or Fortran · HallThruster.jl"/><meta name="description" content="Documentation for HallThruster.jl."/><meta property="og:description" content="Documentation for HallThruster.jl."/><meta property="twitter:description" content="Documentation for HallThruster.jl."/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><link href="../../assets/citation.css" rel="stylesheet" type="text/css"/><link href="../../assets/favicon.ico" rel="icon" type="image/x-icon"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.svg" alt="HallThruster.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">HallThruster.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Overview</a></li><li><a class="tocitem" href="../../NEWS/">Release notes</a></li><li><a class="tocitem" href="../../highlights/">Science highlights</a></li><li><input class="collapse-toggle" id="menuitem-4" type="checkbox"/><label class="tocitem" for="menuitem-4"><span class="docs-label">Tutorials</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../tutorials/simulation/">Run a simulation</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5" type="checkbox" checked/><label class="tocitem" for="menuitem-5"><span class="docs-label">How-to guides</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../json/">Use JSON input and output</a></li><li><a class="tocitem" href="../python/">Run a simulation from python</a></li><li><a class="tocitem" href="../new_propellant/">Add a new propellant</a></li><li><a class="tocitem" href="../new_anom_model/">Implement an anomalous transport model</a></li><li class="is-active"><a class="tocitem" href>Couple HallThruster.jl to C or Fortran</a><ul class="internal"><li><a class="tocitem" href="#Anomalous-transport-model"><span>Anomalous transport model</span></a></li><li><a class="tocitem" href="#Heavy-species-solver"><span>Heavy species solver</span></a></li><li><a class="tocitem" href="#Electron-energy"><span>Electron energy</span></a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-6" type="checkbox"/><label class="tocitem" for="menuitem-6"><span class="docs-label">Explanations</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../explanation/physics/">Physics model</a></li><li><a class="tocitem" href="../../explanation/numerics/">Numerics</a></li><li><a class="tocitem" href="../../explanation/grid_generation/">Grid generation</a></li><li><a class="tocitem" href="../../explanation/timestepping/">Timestepping</a></li><li><a class="tocitem" href="../../explanation/verification/">Validation and verification</a></li><li><a class="tocitem" href="../../explanation/initialization/">Initialization</a></li><li><a class="tocitem" href="../../explanation/plume/">Quasi-1D plume model</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-7" type="checkbox"/><label class="tocitem" for="menuitem-7"><span class="docs-label">Reference</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../reference/config/">Configuration</a></li><li><a class="tocitem" href="../../reference/simparams/">Simulation parameters</a></li><li><a class="tocitem" href="../../reference/solution/">Solution</a></li><li><a class="tocitem" href="../../reference/postprocessing/">Postprocessing</a></li><li><a class="tocitem" href="../../reference/thrusters/">Thrusters</a></li><li><a class="tocitem" href="../../reference/propellants/">Propellants</a></li><li><a class="tocitem" href="../../reference/anomalous_transport/">Anomalous transport models</a></li><li><a class="tocitem" href="../../reference/wall_loss_models/">Wall loss models</a></li><li><a class="tocitem" href="../../reference/electron_thermal_conductivity/">Thermal conductivity models</a></li><li><a class="tocitem" href="../../reference/collisions/">Collisions and reactions</a></li><li><a class="tocitem" href="../../reference/internals/">Internals</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">How-to guides</a></li><li class="is-active"><a href>Couple HallThruster.jl to C or Fortran</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Couple HallThruster.jl to C or Fortran</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/UM-PEPL/HallThruster.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/UM-PEPL/HallThruster.jl/blob/main/docs/src/howto/coupling.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Coupling-HallThruster.jl-to-C-or-Fortran"><a class="docs-heading-anchor" href="#Coupling-HallThruster.jl-to-C-or-Fortran">Coupling HallThruster.jl to C or Fortran</a><a id="Coupling-HallThruster.jl-to-C-or-Fortran-1"></a><a class="docs-heading-anchor-permalink" href="#Coupling-HallThruster.jl-to-C-or-Fortran" title="Permalink"></a></h1><p>HallThruster.jl allows users to modify the solver using their own code. In most cases, this code would be written in Julia (see <a href="../new_anom_model/#Adding-an-anomalous-transport-model">Adding an anomalous transport model</a>), but some users may wish to couple HallThruruster.jl to a pre-existing code written in C++ or Fortran. This guide demonstrates how to do so in each of the three places in the code that accept user code – the heavy species solver, the electron energy solver, and the anomalous transport module. Before reading through this guide, I recommend reading the Julia manual section on <a href="https://docs.julialang.org/en/v1/manual/calling-c-and-fortran-code/">calling C and Fortran code</a>.</p><h2 id="Anomalous-transport-model"><a class="docs-heading-anchor" href="#Anomalous-transport-model">Anomalous transport model</a><a id="Anomalous-transport-model-1"></a><a class="docs-heading-anchor-permalink" href="#Anomalous-transport-model" title="Permalink"></a></h2><p>Here, we&#39;ll demonstrate writing a simple anomalous transport model in Fortran. Along the way, we&#39;ll show off all of the fundamentals necessary to use external code anywhere in HallThruster.jl. A C/C++ version is also available in this repository. See <a href="https://github.com/UM-PEPL/HallThruster.jl/tree/main/test/external_coupling/anom.cpp">test/external_coupling/anom.cpp</a> for the C/C++ source and <a href="https://github.com/UM-PEPL/HallThruster.jl/tree/main/test/external_coupling/anom.jl">test/external_coupling/anom.jl</a> for a test script that runs both the C and fortran versions of this tutorial.</p><p>For this tutorial, we&#39;ll implement a two-zone Bohm model. This model is defined as </p><p class="math-container">\[\nu_{an} = \begin{cases}
    c_1 \omega_{ce} &amp; z &lt; L_{ch} \\
    c_2 \omega_{ce} &amp; z \ge L_{ch}
\end{cases}\]</p><p>Here, <span>$c_1$</span> and <span>$c_2$</span> are two user-defined parameters, <span>$z$</span> is the axial position, <span>$L_{ch}$</span> is the channel length, and <span>$\omega_{ce} = q_e B / m_e$</span> is the electron cyclotron frequency. As discussed in the <a href="../new_anom_model/#Adding-an-anomalous-transport-model">Adding an anomalous transport model</a>, to create a transport model we need to define a struct that is a subtype of <code>AnomalousTransportModel</code> as well as a function that computes the anomalous collision frequency given the <code>params</code> object and the config (see <a href="../../reference/internals/#Internals">Internals</a> for more information on the <code>params</code> object). The struct can be defined as below.</p><pre><code class="language-julia hljs">using HallThruster: HallThruster as het

struct TwoZoneBohm_F90 &lt;: het.AnomalousTransportModel
    c::NTuple{2, Float64}
end</code></pre><p>The function skeleton would then look like the following.</p><pre><code class="language-julia hljs">function (model::TwoZoneBohm_F90)(nu_an, params, config)
    # DO SOMETHING HERE
end</code></pre><p>To fill in the meat of the function, we first need to write our Fortran code. We&#39;ll wrap it in a module called <code>Anom</code> and put it in a file called <code>anom.f90</code>. Note that we will have to pass vectors from julia as pointers, so we will need to supply Fortran with the array length.</p><pre><code class="language-fortran hljs">module Anom

use iso_fortran_env
use iso_c_binding

contains

subroutine two_zone_bohm(nu_anom, z, B, params, channel_length, num_cells) bind(c)
    implicit none
    integer(int64), intent(in):: num_cells
    real(real64), intent(out):: nu_anom(num_cells)
    real(real64), intent(in):: z(num_cells), B(num_cells), params(2), channel_length
    real(real64), parameter:: q_e = 1.60217663e-19, m_e = 9.1093837e-31
    real(real64):: cyclotron_freq = 0.0
    integer(int64):: i = 0

    do i = 1, num_cells
        cyclotron_freq = q_e * B(i) / m_e
        if (z(i) .lt. channel_length) then
            nu_anom(i) = params(1) * cyclotron_freq
        else
            nu_anom(i) = params(2) * cyclotron_freq
        endif
    end do

end subroutine two_zone_bohm

end module Anom</code></pre><p>Here, we have used the <code>bind(c)</code> attribute (from <code>iso_c_binding</code>) to give us some more control over how the symbol will appear in the shared library. We compile this into a shared library called &quot;anom_f90.so&quot; using the following command.</p><pre><code class="nohighlight hljs">gfortran anom.f90 -o anom_f90.so -shared -fPIC </code></pre><p>Next, we need to know what our function is called in the shared library. We can run <code>nm</code> to do this:</p><pre><code class="nohighlight hljs">&gt; nm -gD anom_f90.so
                 w _ITM_deregisterTMCloneTable
                 w _ITM_registerTMCloneTable
                 w __cxa_finalize
                 w __gmon_start__
00000000000010f9 T two_zone_bohm</code></pre><p>Luckily, it&#39;s just called <code>two_zone_bohm</code>. We can now fill in the function.  All vectors must be passed as pointers, while scalars need to be passed as references. Since we&#39;re using a subroutine, we supply a return type of <code>Cvoid</code>, indicating that nothing is returned. If we used a function instead, we would need to supply an appropriate return type. The Julia documentation linked above has an extensive list of type correspondances between Julia and C, and the <code>iso_c_env</code> module makes it easier to interface Fortran types to C types.</p><pre><code class="language-julia hljs">function (model::TwoZoneBohm_F90)(nu_an, params, config)
    # Extract some things from params
    (;thruster, grid, cache) = params
    channel_length = thruster.geometry.channel_length
    num_cells = length(grid.cell_centers)

    # use @ccall to call out to our shared library
    @ccall &quot;anom_f90.so&quot;.two_zone_bohm(
        nu_an::Ptr{Float64},
        grid.cell_centers::Ptr{Float64},
        cache.B::Ptr{Float64},
        model.c::Ref{NTuple{2, Float64}},
        channel_length::Ref{Float64},
        num_cells::Ref{Int64}
    )::Cvoid

    return nu_an
end</code></pre><p>Finally, we can set up a simulation and run it like we would for any other anomalous transport model.</p><pre><code class="language-julia hljs">model = TwoZoneBohm_F90((0.05, 0.5))

config = het.Config(
    thruster = het.SPT_100,
    propellants = [het.Propellant(het.Xenon, 5e-6)],
    domain = (0.0, 0.08),
    discharge_voltage = 300.0,
    anom_model = model
)

simparams = het.SimParams(grid = het.UnevenGrid(100))
solution = het.run_simulation(config, simparams)</code></pre><h2 id="Heavy-species-solver"><a class="docs-heading-anchor" href="#Heavy-species-solver">Heavy species solver</a><a id="Heavy-species-solver-1"></a><a class="docs-heading-anchor-permalink" href="#Heavy-species-solver" title="Permalink"></a></h2><p>For the remaining source terms, the process of linking to external C and Fortran code is identical to the above. Only the expected interface on the Julia side is different.</p><p>The user-provided source term for the heavy species is called twice per timestep, once per stage of the second-order SSPRK22 algorithm. It has the following signature:</p><pre><code class="language-julia hljs">source_heavy_species(fluid_containers, params)::Nothing</code></pre><p>The heavy species source terms should ideally add something to the <code>dens_ddt</code> and <code>mom_ddt</code> fields of some or all of the available <code>fluid_containers</code> (see <a href="../../reference/internals/#Internals">Internals</a>) for more. These fields represent the right-hand side of the fluid equations for each species. Below is an example of how we use this in our order verification tests, but the internals of this function could be replaced with anything, including external C or Fortran code.</p><pre><code class="language-julia hljs">function source_heavy_species(fluid_containers, params)
    (; grid) = params
    (; continuity, isothermal) = fluid_containers

    for i in 2:(length(grid.cell_centers) - 1)
        continuity[1].dens_ddt[i] += source_ρn(grid.cell_centers[i])
        isothermal[1].dens_ddt[i] += source_ρi(grid.cell_centers[i])
        isothermal[1].mom_ddt[i] += source_ρiui(grid.cell_centers[i])
    end
    return
end</code></pre><h2 id="Electron-energy"><a class="docs-heading-anchor" href="#Electron-energy">Electron energy</a><a id="Electron-energy-1"></a><a class="docs-heading-anchor-permalink" href="#Electron-energy" title="Permalink"></a></h2><div class="admonition is-warning" id="Under-development-e220d3c2b9838b25"><header class="admonition-header">Under development<a class="admonition-anchor" href="#Under-development-e220d3c2b9838b25" title="Permalink"></a></header><div class="admonition-body"><p>This interface is likely to change before v1.0</p></div></div><p>The electron source term has the following signature.</p><pre><code class="language-julia hljs">source_electrons(params, i) -&gt; Float64</code></pre><p>Here, <code>i</code> is a cell index. This function computes the energy source term for a single cell and returns it, as opposed to modifying a buffer.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../new_anom_model/">« Implement an anomalous transport model</a><a class="docs-footer-nextpage" href="../../explanation/physics/">Physics model »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.14.1 on <span class="colophon-date" title="Wednesday 15 October 2025 18:10">Wednesday 15 October 2025</span>. Using Julia version 1.12.0.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
